<!DOCTYPE html>

<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ONLY HOME FOOD</title>
  <link rel="stylesheet" href="../../assets/css/header.css">
  <link rel="stylesheet" href="../../assets/css/footer.css">
  <link rel="stylesheet" href="../../assets/css/order history.css">
  <link rel="icon" href="../../assets/Images/LOGO.png" type="image/x-icon">
</head>

<body>

  <section class="order_details">

  </section>

  <!-- header script -->
  <script src="../../assets/javascript/header.js"></script>

  <!-- footer script -->
  <script src="../../assets/javascript/footer.js"></script>
  <script>
    let p;
    let div_order;
    let image;
    let div_name;
    let p_fname;
    // let p_quantity;
    // let p_impnote;
    let div_cbut;
    // let a;
    let button;

    const order_history = JSON.parse(localStorage.getItem("order_list"));

    const url = window.location.search;
    const urlParams = new URLSearchParams(url);
    const order_id = urlParams.get("order_id");
    console.log(order_id);

    const product_list = JSON.parse(localStorage.getItem("product_list"));
    // console.log(product_list)

    const orderItem = JSON.parse(localStorage.getItem("ordered_items"));

    const orders = order_history.find((e) => e.order_id === order_id);
    console.log(orders);

    const items = orderItem.filter((e) => e.order_id === orders.order_id);
    console.log(items)

    const foodData = product_list.filter((product) =>
      items.some((id) => id.product_id === product.product_id)
    );
    // console.log(foodData)

    // <div class="popuup">
    const div_popup = document.createElement("div");
    div_popup.setAttribute("class", "popup");
    console.log(div_popup);

    // <h3> order_num
    const h3_order_num = document.createElement("h3");
    h3_order_num.innerText = `Order_id: ${order_id}`;
    div_popup.append(h3_order_num);

    // <div class="phead">
    const div_phead = document.createElement("div");
    div_phead.setAttribute("class", "phead");
    div_popup.append(div_phead);

    // <p>
    p = document.createElement("p");
    p.innerText = "Food Name";
    div_phead.append(p);

    p = document.createElement("p");
    p.setAttribute("class", "quan");
    p.innerText = "Quantity";
    div_phead.append(p);

    p = document.createElement("p");
    p.innerText = "Price";
    div_phead.append(p);

    p = document.createElement("p");
    p.innerText = "Delivery";
    div_phead.append(p);

    // Order list //
    for (let i = 0; i < foodData.length; i++) {
      // <div class="order">
      div_order = document.createElement("div");
      div_order.setAttribute("class", "orderr");
      div_popup.append(div_order);

      image = document.createElement("img");
      image.setAttribute("src", foodData[i].product_image);
      image.setAttribute("alt", `${foodData[i].product_name} image`);
      div_order.append(image);

      div_name = document.createElement("div");
      div_name.setAttribute("class", "name");
      div_order.append(div_name);

      p_fname = document.createElement("p");
      p_fname.setAttribute("class", "fname");
      p_fname.innerText = foodData[i].product_name;
      div_name.append(p_fname);

      p_fname = document.createElement("p");
      p_fname.setAttribute("class", "fname");
      p_fname.innerText = foodData[i].product_type;
      div_name.append(p_fname);

      p = document.createElement("p");
      p.setAttribute("class", "quantity");
      p.innerText = items[i].quantity_ordered;
      div_order.append(p);


      p = document.createElement("p");
      p.setAttribute("class", "cost");
      p.innerText = `Rs. ${foodData[i].product_price * items[i].quantity_ordered}`;
      div_order.append(p);

      p = document.createElement("p");
      p.setAttribute("class", "deliveryStatus");
      p.innerText = "(" + items[i].delivery_time[0] + ") " + items[i].order_status;
      div_order.append(p);

    }

    // To get the address //

    let address = JSON.parse(localStorage.getItem("address"));

    let deliveryAddress = address.filter((id) => id.address_id === orders.delivery_address_Id);

    console.log(deliveryAddress)
    // Create the outermost div element with class "delivery-address-box"
    const deliveryAddressBox = document.createElement("div");
    deliveryAddressBox.classList.add("delivery-address-box");
    div_popup.append(deliveryAddressBox);

    // Create the div element with class "address-head"
    const addressHead = document.createElement("div");
    addressHead.classList.add("address-head");

    // Create the image element
    const houseimage = document.createElement("img");
    houseimage.classList.add("greenHouse");
    houseimage.src = "../../assets/Images/Green house.png";
    houseimage.alt = "green house image";

    // Create the h2 element with class "side-head"
    const heading = document.createElement("h2");
    heading.classList.add("side-head");
    heading.textContent = "Delivery details";

    // Append the image and heading elements to the addressHead div
    addressHead.appendChild(houseimage);
    addressHead.appendChild(heading);

    // Create the div element with class "address-content"
    const addressContent = document.createElement("div");
    addressContent.classList.add("address-content");

    // Create the p elements with the respective content
    const nameParagraph = document.createElement("p");
    nameParagraph.classList.add("delivery-name");
    nameParagraph.textContent = deliveryAddress[0].name;

    const addressParagraph = document.createElement("p");
    addressParagraph.textContent = deliveryAddress[0].house_number + ", " + deliveryAddress[0].town_name ;

    const locationParagraph = document.createElement("p");
    locationParagraph.textContent = deliveryAddress[0].city + " - " + deliveryAddress[0].pinCode;

    const mobileParagraph = document.createElement("p");
    mobileParagraph.textContent = "Mobile - " + deliveryAddress[0].mobile_number;

    // Append the p elements to the addressContent div
    addressContent.appendChild(nameParagraph);
    addressContent.appendChild(addressParagraph);
    addressContent.appendChild(locationParagraph);
    addressContent.appendChild(mobileParagraph);

    // Append the addressHead and addressContent divs to the deliveryAddressBox div
    deliveryAddressBox.appendChild(addressHead);
    deliveryAddressBox.appendChild(addressContent);


    // <div class="dpara">
    const div_dpara = document.createElement("div");
    div_dpara.setAttribute("class", "dpara");
    div_popup.append(div_dpara);

    // <div class="lpara">
    const div_lpara = document.createElement("div");
    div_lpara.setAttribute("class", "lpara");
    div_dpara.append(div_lpara);

    // <p>
    p = document.createElement("p");
    p.innerText = "Ordered time";
    div_lpara.append(p);

    // p = document.createElement("p");
    // p.innerText = "Delivery status";
    // div_lpara.append(p);

    p = document.createElement("p");
    p.innerText = "Total";
    div_lpara.append(p);

    p = document.createElement("p");
    p.innerText = "Payment";
    div_lpara.append(p);

    // <div class="spara">
    const div_spara = document.createElement("div");
    div_spara.setAttribute("class", "spara");
    div_dpara.append(div_spara);

    // Date format to show //
    const d = new Date(orders.ordered_time);
    const weekday = new Array("Sun", "Mon", "Tue", "Wed", "Thur", "Fri", "Sat");
    const dayOfWeek = weekday[d.getDay()];
    const domEnder = (function () {
      let a = d;
      if (/1/.test(parseInt(`${a}`.charAt(0)))) return "th";
      a = parseInt(`${a}`.charAt(1));
      return a === 1 ? "st" : a === 2 ? "nd" : a === 3 ? "rd" : "th";
    })();
    const dayOfMonth = (d.getDate() < 10 ? "0" : "") + d.getDate() + domEnder;
    const months = new Array(
      "January",
      "February",
      "Mar",
      "April",
      "May",
      "June",
      "July",
      "August",
      "September",
      "October",
      "November",
      "December"
    );
    const curMonth = months[d.getMonth()];
    const curYear = d.getFullYear();
    const curHour =
      d.getHours() > 12
        ? d.getHours() - 12
        : d.getHours() < 10
          ? `0${d.getHours()}`
          : d.getHours();
    const curMinute = d.getMinutes() < 10 ? `0${d.getMinutes()}` : d.getMinutes();
    const curSeconds = d.getSeconds() < 10 ? `0${d.getSeconds()}` : d.getSeconds();
    const curMeridiem = d.getHours() >= 12 ? "PM" : "AM";
    const orderTime = `${dayOfMonth} ${curMonth} ${curYear},${dayOfWeek} ${curHour}:${curMinute}:${curSeconds} ${curMeridiem}`;

    // <p>
    p = document.createElement("p");
    p.innerText = orderTime;
    div_spara.append(p);

    // p = document.createElement("p");
    // p.innerText = "Not delivered";
    // div_spara.append(p);

    p = document.createElement("p");
    p.innerText = `Rs.${orders.total_price}`;
    div_spara.append(p);

    p = document.createElement("p");
    p.innerText = "COD";
    div_spara.append(p);

    // <p class="impnote">
    p = document.createElement("p");
    p.setAttribute("class", "impnote");
    p.innerText =
      "Note: You can only cancel your order on the same day of the placement.";
    div_popup.append(p);

    // <div class="cbut">
    div_cbut = document.createElement("div");
    div_cbut.setAttribute("class", "cbut");
    div_popup.append(div_cbut);

    // Function for button //
    const startTime = d;

    const endTime = new Date(
      startTime.getFullYear(),
      startTime.getMonth(),
      startTime.getDate() + 1,
      0,
      0,
      0,
      0
    );
    const now = new Date();

    if (endTime > now) {
      // <button>
      if (orders.order_status === "Cancelled") {
        button = document.createElement("button");
        button.setAttribute("class", "cancel_order");
        button.setAttribute("style", "display:none");
        button.innerText = "Cancel order";
        div_cbut.append(button);
      } else {
        button = document.createElement("button");
        button.setAttribute("class", "cancel_order");
        button.setAttribute("onclick", "cancel()");
        button.innerText = "Cancel order";
        div_cbut.append(button);
      }
    }

    button = document.createElement("button");
    button.setAttribute("class", "re_order");
    button.setAttribute("onclick", "re_order()");
    button.innerText = "Re-order";
    div_cbut.append(button);

    // <button>
    button = document.createElement("button");
    button.setAttribute("onclick", "btn()");
    button.setAttribute("type", "close");
    button.innerText = "Close";
    div_cbut.append(button);

    document.querySelector("section.order_details").append(div_popup);

    function btn() {
      window.location.href = "./Profile.html";
    }

    function cancel() {
      if (confirm("This order will be cancelled completely")) {
        for (let i = 0; i < items.length; i++) {
          items[i].order_status = "Cancelled";
        }
        localStorage.setItem("ordered_items", JSON.stringify(orderItem));
        window.location.href = "../Login and Order/Profile.html";
      }
    }

    function re_order() {
      let cart_product = JSON.parse(localStorage.getItem("cart_product"));
      cart_product = cart_product.filter((e) => e.user_id !== userId);
      cart_product.push(...items);
      localStorage.setItem("cart_product", JSON.stringify(cart_product));
      localStorage.setItem("food_count", parseInt(items.length));
      alert("Your product is added to the cart");
      window.location.href = "../Cart/cart.html";
    }
  </script>
</body>

</html>